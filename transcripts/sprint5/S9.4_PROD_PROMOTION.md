# S9.4: Production Promotion via Release

**Video Duration:** ~10 minutes  
**Story Points:** 3

---

## Learning Objectives

By the end of this video, you will be able to:
- Create release-triggered deployments
- Configure GitHub environment protection
- Implement approval gates
- Use semantic versioning

---

## Transcript

### Introduction (0:00 - 1:00)

Welcome back! Dev deployments are automatic, but production needs control. You don't want every merge going straight to prod!

We'll use GitHub Releases with approval gates.

### The Production Flow (1:00 - 2:00)

```
Create Release (v1.0.0)
       â†“
Build all services with release tag
       â†“
ðŸ”’ Wait for approval
       â†“
Update prod GitOps
       â†“
ArgoCD syncs to prod
       â†“
Celebrate! ðŸŽ‰
```

### GitHub Environment Protection (2:00 - 3:30)

*[Shows GitHub Settings]*

1. Go to Settings â†’ Environments
2. Create environment: `production`
3. Configure protection rules:
   - âœ“ Required reviewers (add team leads)
   - âœ“ Wait timer: 5 minutes (optional)
   - âœ“ Deployment branches: tags only

Now only tagged releases can deploy to prod, and they need approval!

### Release Workflow (3:30 - 6:00)

```yaml
name: Release to Production

on:
  release:
    types: [published]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate semver
        run: |
          TAG=${{ github.event.release.tag_name }}
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid tag: $TAG"
            exit 1
          fi

  build-all:
    needs: validate
    strategy:
      matrix:
        service: [api-gateway, product-service, order-service, ...]
    steps:
      - name: Build with release tag
        run: |
          docker build -t $REGISTRY/${{ matrix.service }}:${{ github.event.release.tag_name }}
          docker push ...

  deploy-prod:
    needs: build-all
    environment: production  # Requires approval!
    steps:
      - name: Update prod GitOps
        run: |
          cd environments/prod
          for svc in api-gateway product-service ...; do
            yq -i '.images[0].newTag = "${{ github.event.release.tag_name }}"' \
              $svc/kustomization.yaml
          done
          git commit -m "release: ${{ github.event.release.tag_name }}"
          git push
```

The `environment: production` line triggers the approval gate!

### Creating a Release (6:00 - 7:30)

*[Shows GitHub]*

1. Go to Releases â†’ Draft a new release
2. Create tag: `v1.0.0`
3. Title: `Release v1.0.0`
4. Write release notes
5. Click Publish

*[Shows workflow starting]*

Look - it's waiting for approval!

*[Clicks Approve]*

Now it continues and deploys to prod!

### Semantic Versioning (7:30 - 8:30)

Use proper versioning:
- **v1.0.0** â†’ **v1.0.1**: Bug fix
- **v1.0.0** â†’ **v1.1.0**: New feature
- **v1.0.0** â†’ **v2.0.0**: Breaking change

The release workflow validates the format.

### ArgoCD Manual Sync for Prod (8:30 - 9:30)

For extra safety, prod apps don't have automatic sync:

```yaml
# prod Application
syncPolicy:
  # No automated sync!
  syncOptions:
    - CreateNamespace=true
```

After release, manually sync:

```bash
argocd app sync api-gateway-prod
argocd app sync product-service-prod
```

Or click "Sync" in the UI.

### Summary (9:30 - 10:00)

We implemented:
1. Release-triggered production deploys
2. GitHub environment protection
3. Required approvals before prod
4. Semantic versioning validation

Production is now safely controlled!

---

## Key Takeaways

- Releases trigger production deploys
- Environment protection requires approval
- Semantic versioning communicates changes
- Manual ArgoCD sync adds another safety layer
- Clear separation between dev (auto) and prod (manual)
