# S2.2: GitHub OIDC for Keyless AWS Access

**Video Duration:** ~10 minutes  
**Story Points:** 2

---

## Learning Objectives

By the end of this video, you will be able to:
- Understand OIDC authentication
- Configure AWS as an OIDC identity provider
- Create IAM roles for GitHub Actions
- Eliminate hardcoded AWS credentials

---

## Transcript

### Introduction (0:00 - 1:00)

Welcome back! This video is about security - specifically, how to give GitHub Actions access to AWS without storing any credentials.

If you've ever created AWS access keys and stored them as GitHub secrets, you know the risk. Keys can leak, get committed accidentally, or be shared insecurely. OIDC eliminates all of that.

Let's see how it works!

### How OIDC Works (1:00 - 2:30)

OIDC stands for OpenID Connect. Here's the flow:

1. GitHub Actions workflow starts
2. GitHub generates a short-lived JWT token
3. Token is sent to AWS STS (Security Token Service)
4. AWS validates the token against GitHub's OIDC provider
5. AWS issues temporary credentials
6. Workflow uses those credentials

The magic? No long-lived credentials anywhere! The temporary credentials expire automatically.

It's like checking into a hotel with your ID. The hotel (AWS) trusts the government (GitHub) that issued your ID. You don't need to give them your house keys.

### Setting Up the OIDC Provider (2:30 - 4:00)

Let me show you the Terraform code.

*[Opens github-oidc.tf]*

```hcl
data "tls_certificate" "github" {
  url = "https://token.actions.githubusercontent.com/.well-known/openid-configuration"
}

resource "aws_iam_openid_connect_provider" "github" {
  url             = "https://token.actions.githubusercontent.com"
  client_id_list  = ["sts.amazonaws.com"]
  thumbprint_list = [data.tls_certificate.github.certificates[0].sha1_fingerprint]
}
```

This creates an OIDC identity provider in AWS. We're telling AWS: "Trust tokens from GitHub."

The thumbprint is GitHub's certificate fingerprint - AWS uses this to verify tokens are really from GitHub.

### Creating the IAM Role (4:00 - 6:00)

Now we create a role that GitHub can assume:

```hcl
resource "aws_iam_role" "github_actions" {
  name = "techitfactory-github-terraform"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Action = "sts:AssumeRoleWithWebIdentity"
      Effect = "Allow"
      Principal = {
        Federated = aws_iam_openid_connect_provider.github.arn
      }
      Condition = {
        StringEquals = {
          "token.actions.githubusercontent.com:aud" = "sts.amazonaws.com"
        }
        StringLike = {
          "token.actions.githubusercontent.com:sub" = "repo:TechITFactory/*:*"
        }
      }
    }]
  })
}
```

See those conditions? They're critical for security!

The `aud` (audience) must be `sts.amazonaws.com`.
The `sub` (subject) must match our organization's repos.

This means only workflows from TechITFactory repositories can assume this role. A random repo can't steal our access!

### Attaching Permissions (6:00 - 7:30)

Now we give the role permissions:

```hcl
resource "aws_iam_role_policy_attachment" "github_admin" {
  policy_arn = "arn:aws:iam::aws:policy/AdministratorAccess"
  role       = aws_iam_role.github_actions.name
}
```

For this course, I'm using AdministratorAccess. In production, you'd create a custom policy with only the permissions Terraform needs.

### Using OIDC in GitHub Actions (7:30 - 9:00)

Here's how to use this in a workflow:

```yaml
jobs:
  terraform:
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # Required for OIDC!
      contents: read

    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::ACCOUNT:role/techitfactory-github-terraform
          aws-region: ap-south-1
```

Two critical things:
1. `permissions.id-token: write` - allows the workflow to request tokens
2. `role-to-assume` - the ARN of our IAM role

No access keys needed! No secrets to rotate!

### Deploying (9:00 - 9:30)

Let's apply this:

```bash
cd techitfactory-infra/bootstrap
terraform apply
```

*[Shows apply completing]*

The OIDC provider and role are now created.

### Summary (9:30 - 10:00)

What we accomplished:
1. Created GitHub as an OIDC identity provider in AWS
2. Created an IAM role with proper trust policy
3. Secured it with conditions to only allow our repos
4. No long-lived credentials anywhere!

This is a security best practice used at all major companies. Next, we'll set up our module skeletons!

---

## Key Takeaways

- OIDC provides temporary credentials without storing secrets
- Trust policies restrict which repos can assume roles
- The `id-token: write` permission is required for OIDC
- This is more secure than access keys in GitHub secrets
