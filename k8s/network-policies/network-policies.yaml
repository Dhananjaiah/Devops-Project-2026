# Network Policies for E-Commerce Microservices
# These policies restrict network traffic between pods for improved security

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: product-service-network-policy
  namespace: ecommerce
spec:
  podSelector:
    matchLabels:
      app: product-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow traffic from cart-service and order-service
  - from:
    - podSelector:
        matchLabels:
          app: cart-service
    - podSelector:
        matchLabels:
          app: order-service
    # Allow traffic from an external Gateway implementation namespace.
    # Label your gateway namespace like:
    # kubectl label namespace <gateway-namespace> ecommerce.dev/gateway-access=true
    - namespaceSelector:
        matchLabels:
          ecommerce.dev/gateway-access: "true"
    ports:
    - protocol: TCP
      port: 3001
  egress:
  # Allow access to MongoDB
  - to:
    - podSelector:
        matchLabels:
          app: mongodb
    ports:
    - protocol: TCP
      port: 27017
  # Allow DNS
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: user-service-network-policy
  namespace: ecommerce
spec:
  podSelector:
    matchLabels:
      app: user-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow traffic from ingress controller
  - from:
    - namespaceSelector:
        matchLabels:
          ecommerce.dev/gateway-access: "true"
    ports:
    - protocol: TCP
      port: 3002
  egress:
  # Allow access to MongoDB
  - to:
    - podSelector:
        matchLabels:
          app: mongodb
    ports:
    - protocol: TCP
      port: 27017
  # Allow DNS
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: cart-service-network-policy
  namespace: ecommerce
spec:
  podSelector:
    matchLabels:
      app: cart-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow traffic from order-service and ingress controller
  - from:
    - podSelector:
        matchLabels:
          app: order-service
    - namespaceSelector:
        matchLabels:
          ecommerce.dev/gateway-access: "true"
    ports:
    - protocol: TCP
      port: 3003
  egress:
  # Allow access to MongoDB
  - to:
    - podSelector:
        matchLabels:
          app: mongodb
    ports:
    - protocol: TCP
      port: 27017
  # Allow access to product-service
  - to:
    - podSelector:
        matchLabels:
          app: product-service
    ports:
    - protocol: TCP
      port: 3001
  # Allow DNS
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: order-service-network-policy
  namespace: ecommerce
spec:
  podSelector:
    matchLabels:
      app: order-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow traffic from ingress controller
  - from:
    - namespaceSelector:
        matchLabels:
          ecommerce.dev/gateway-access: "true"
    ports:
    - protocol: TCP
      port: 3004
  egress:
  # Allow access to MongoDB
  - to:
    - podSelector:
        matchLabels:
          app: mongodb
    ports:
    - protocol: TCP
      port: 27017
  # Allow access to cart-service
  - to:
    - podSelector:
        matchLabels:
          app: cart-service
    ports:
    - protocol: TCP
      port: 3003
  # Allow access to product-service
  - to:
    - podSelector:
        matchLabels:
          app: product-service
    ports:
    - protocol: TCP
      port: 3001
  # Allow DNS
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mongodb-network-policy
  namespace: ecommerce
spec:
  podSelector:
    matchLabels:
      app: mongodb
  policyTypes:
  - Ingress
  ingress:
  # Only allow access from microservices
  - from:
    - podSelector:
        matchLabels:
          app: product-service
    - podSelector:
        matchLabels:
          app: user-service
    - podSelector:
        matchLabels:
          app: cart-service
    - podSelector:
        matchLabels:
          app: order-service
    ports:
    - protocol: TCP
      port: 27017
