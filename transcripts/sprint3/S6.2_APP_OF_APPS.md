# S6.2: App-of-Apps Pattern

**Video Duration:** ~12 minutes  
**Story Points:** 3

---

## Learning Objectives

By the end of this video, you will be able to:
- Understand the App-of-Apps pattern
- Create Kustomize overlays for environments
- Configure automated sync policies
- Manage multiple applications declaratively

---

## Transcript

### Introduction (0:00 - 1:00)

Welcome back! Creating one app is easy. But what about 6 services, across dev and prod environments? That's 12+ applications!

The App-of-Apps pattern solves this elegantly. Let's see how.

### The App-of-Apps Pattern (1:00 - 3:00)

The concept is simple: Create one "root" Application that manages other Applications.

*[Shows diagram]*

```
root-app
├── frontend
├── api-gateway
├── product-service
├── order-service
├── cart-service
├── user-service
└── monitoring
```

When you sync root-app, it creates all the child applications. It's applications all the way down!

### Creating the Root App (3:00 - 5:00)

```yaml
# apps/root-app.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: root-app
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://github.com/TechITFactory/techitfactory-gitops.git
    targetRevision: main
    path: apps
  destination:
    server: https://kubernetes.default.svc
    namespace: argocd
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
```

The root app points to the `apps/` directory, which contains all our Application manifests.

### Child Application Example (5:00 - 6:30)

```yaml
# apps/api-gateway.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: api-gateway
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/TechITFactory/techitfactory-gitops.git
    targetRevision: main
    path: environments/dev/api-gateway
  destination:
    server: https://kubernetes.default.svc
    namespace: techitfactory
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
```

Each child app points to its Kustomize overlay in `environments/dev/`.

### Kustomize Overlays (6:30 - 8:30)

Our structure:

```
techitfactory-gitops/
├── base/
│   └── api-gateway/
│       ├── deployment.yaml
│       ├── service.yaml
│       └── kustomization.yaml
└── environments/
    ├── dev/
    │   └── api-gateway/
    │       └── kustomization.yaml
    └── prod/
        └── api-gateway/
            └── kustomization.yaml
```

Base contains the actual Kubernetes manifests:

```yaml
# base/api-gateway/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - deployment.yaml
  - service.yaml
```

Overlays patch for each environment:

```yaml
# environments/dev/api-gateway/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: techitfactory

resources:
  - ../../../base/api-gateway

images:
  - name: IMAGE_PLACEHOLDER
    newName: ACCOUNT.dkr.ecr.ap-south-1.amazonaws.com/techitfactory/api-gateway
    newTag: latest

replicas:
  - name: api-gateway
    count: 2
```

### Sync Policies Explained (8:30 - 10:00)

```yaml
syncPolicy:
  automated:
    prune: true      # Delete resources not in Git
    selfHeal: true   # Revert manual changes
```

**prune** - If you delete a file from Git, ArgoCD deletes it from the cluster.

**selfHeal** - If someone `kubectl edit`s something, ArgoCD reverts it.

This is powerful! Git is always the truth.

### Deploying (10:00 - 11:30)

```bash
kubectl apply -f apps/root-app.yaml

argocd app list
```

*[Shows all apps appearing]*

Watch the magic in the UI - all child apps get created!

*[Shows ArgoCD UI with all apps in sync]*

Everything is green and synced!

### Summary (11:30 - 12:00)

We implemented:
1. App-of-Apps pattern for scalable management
2. Kustomize for environment overlays
3. Automated sync with prune and selfHeal
4. One command deploys everything

GitOps is now fully operational!

---

## Key Takeaways

- App-of-Apps manages applications at scale
- Kustomize overlays separate env-specific configs
- prune deletes resources removed from Git
- selfHeal reverts manual cluster changes
- One root app controls the entire platform
