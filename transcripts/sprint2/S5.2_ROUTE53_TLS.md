# S5.2: Route53 and TLS Configuration

**Video Duration:** ~10 minutes  
**Story Points:** 3

---

## Learning Objectives

By the end of this video, you will be able to:
- Configure custom domain with Route53
- Request and validate ACM certificates
- Enable HTTPS on ALB
- Set up automatic certificate renewal

---

## Transcript

### Introduction (0:00 - 1:00)

Welcome back! We have an ALB, but the URL is ugly - something like `k8s-techitfa-techitfa-1234567890.ap-south-1.elb.amazonaws.com`.

Let's set up a proper domain with HTTPS!

### Prerequisites (1:00 - 2:00)

You'll need:
- A domain name (or use Route53 to buy one)
- The domain's hosted zone in Route53

If you don't have a domain, you can still follow along - just skip the certificate validation step.

### Creating ACM Certificate (2:00 - 4:00)

```hcl
resource "aws_acm_certificate" "main" {
  domain_name       = "*.${var.domain_name}"
  validation_method = "DNS"

  subject_alternative_names = [
    var.domain_name
  ]

  lifecycle {
    create_before_destroy = true
  }
}
```

This creates a wildcard certificate for `*.example.com` and `example.com`.

### DNS Validation (4:00 - 5:30)

ACM needs to verify you own the domain:

```hcl
resource "aws_route53_record" "cert_validation" {
  for_each = {
    for dvo in aws_acm_certificate.main.domain_validation_options : dvo.domain_name => {
      name   = dvo.resource_record_name
      record = dvo.resource_record_value
      type   = dvo.resource_record_type
    }
  }

  zone_id = data.aws_route53_zone.main.zone_id
  name    = each.value.name
  type    = each.value.type
  records = [each.value.record]
  ttl     = 60
}

resource "aws_acm_certificate_validation" "main" {
  certificate_arn         = aws_acm_certificate.main.arn
  validation_record_fqdns = [for record in aws_route53_record.cert_validation : record.fqdn]
}
```

This creates the CNAME record AWS requires for validation.

### Updating Ingress for HTTPS (5:30 - 7:00)

Now update the Ingress to use the certificate:

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: techitfactory-ingress
  annotations:
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-south-1:ACCOUNT:certificate/xxx
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: '443'
spec:
  rules:
    - host: app.techitfactory.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend
                port:
                  number: 80
```

Key annotations:
- `certificate-arn` - Points to our ACM certificate
- `listen-ports` - Listen on both HTTP and HTTPS
- `ssl-redirect` - Redirect HTTP to HTTPS

### DNS Record for ALB (7:00 - 8:30)

```hcl
resource "aws_route53_record" "app" {
  zone_id = data.aws_route53_zone.main.zone_id
  name    = "app.${var.domain_name}"
  type    = "A"

  alias {
    name                   = aws_lb.main.dns_name
    zone_id               = aws_lb.main.zone_id
    evaluate_target_health = true
  }
}
```

This creates an A record pointing to the ALB.

Or using External DNS (automated):

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    external-dns.alpha.kubernetes.io/hostname: app.techitfactory.com
```

External DNS automatically creates Route53 records!

### Testing (8:30 - 9:30)

```bash
curl https://app.techitfactory.com/health

# Check certificate
openssl s_client -connect app.techitfactory.com:443 -servername app.techitfactory.com
```

*[Shows valid certificate]*

HTTPS is working with our custom domain!

### Summary (9:30 - 10:00)

We configured:
1. ACM certificate with DNS validation
2. Ingress annotations for HTTPS
3. HTTP to HTTPS redirect
4. Route53 DNS record

Professional, secure endpoints ready for production!

---

## Key Takeaways

- ACM certificates are free and auto-renew
- DNS validation is preferred over email
- ALB can terminate TLS
- ssl-redirect ensures all traffic uses HTTPS
- External DNS automates Route53 records
