# S5.1: AWS Load Balancer Controller

**Video Duration:** ~10 minutes  
**Story Points:** 3

---

## Learning Objectives

By the end of this video, you will be able to:
- Understand ALB vs NLB
- Configure IRSA for ALB Controller
- Install AWS Load Balancer Controller
- Create an Ingress resource

---

## Transcript

### Introduction (0:00 - 1:00)

Welcome back! We have a cluster, but how do users access our applications? We need a load balancer!

AWS Load Balancer Controller is the modern way to provision ALBs and NLBs from Kubernetes.

### ALB vs NLB (1:00 - 2:00)

Quick comparison:

**Application Load Balancer (ALB)**
- Layer 7 (HTTP/HTTPS)
- Path-based routing
- Host-based routing
- Perfect for web apps

**Network Load Balancer (NLB)**
- Layer 4 (TCP/UDP)
- Ultra-low latency
- Static IPs
- Good for non-HTTP workloads

We'll use ALB for our microservices.

### Creating IRSA Role (2:00 - 4:00)

The controller needs permissions to create load balancers:

```hcl
module "alb_controller_irsa" {
  source  = "terraform-aws-modules/iam/aws//modules/iam-role-for-service-accounts-eks"
  
  role_name = "${var.project_name}-${var.environment}-alb-controller"
  
  attach_load_balancer_controller_policy = true
  
  oidc_providers = {
    main = {
      provider_arn   = aws_iam_openid_connect_provider.eks.arn
      namespace      = "kube-system"
      service_account = "aws-load-balancer-controller"
    }
  }
}
```

The policy allows creating ALBs, NLBs, target groups, listeners, and more.

### Installing via Helm (4:00 - 6:00)

```bash
helm repo add eks https://aws.github.io/eks-charts
helm repo update

helm install aws-load-balancer-controller eks/aws-load-balancer-controller \
  -n kube-system \
  --set clusterName=techitfactory-dev \
  --set serviceAccount.create=true \
  --set serviceAccount.name=aws-load-balancer-controller \
  --set serviceAccount.annotations."eks\.amazonaws\.com/role-arn"=$ALB_ROLE_ARN \
  --set region=ap-south-1 \
  --set vpcId=$VPC_ID
```

Let's verify:

```bash
kubectl get deployment -n kube-system aws-load-balancer-controller
kubectl logs -n kube-system -l app.kubernetes.io/name=aws-load-balancer-controller
```

### Creating an Ingress (6:00 - 8:00)

Now let's create an Ingress that provisions an ALB:

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: techitfactory-ingress
  namespace: techitfactory
  annotations:
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/healthcheck-path: /health
spec:
  rules:
    - http:
        paths:
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: api-gateway
                port:
                  number: 80
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend
                port:
                  number: 80
```

Key annotations:
- `scheme: internet-facing` - Public ALB
- `target-type: ip` - Routes directly to pod IPs

```bash
kubectl apply -f ingress.yaml
kubectl get ingress -n techitfactory
```

*[Shows ALB being provisioned]*

After a minute, you'll see the ALB hostname!

### Testing (8:00 - 9:30)

```bash
ALB_URL=$(kubectl get ingress techitfactory-ingress -n techitfactory -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')

curl http://$ALB_URL/health
curl http://$ALB_URL/api/products
```

Traffic flows through ALB to our pods!

### Summary (9:30 - 10:00)

We set up:
1. IRSA role for ALB Controller
2. Controller via Helm
3. Ingress resource
4. Path-based routing

Our apps are now accessible from the internet!

---

## Key Takeaways

- ALB Controller provisions AWS load balancers from K8s
- IRSA provides secure AWS credentials
- Ingress annotations configure ALB behavior
- Target type IP routes directly to pods
- ALB provisioning takes 1-2 minutes
