name: Build and Deploy to EKS

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: ecommerce-cluster

jobs:
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build and push Product Service
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        cd microservices/product-service
        docker build -t $ECR_REGISTRY/product-service:$IMAGE_TAG .
        docker push $ECR_REGISTRY/product-service:$IMAGE_TAG
        docker tag $ECR_REGISTRY/product-service:$IMAGE_TAG $ECR_REGISTRY/product-service:latest
        docker push $ECR_REGISTRY/product-service:latest

    - name: Build and push User Service
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        cd microservices/user-service
        docker build -t $ECR_REGISTRY/user-service:$IMAGE_TAG .
        docker push $ECR_REGISTRY/user-service:$IMAGE_TAG
        docker tag $ECR_REGISTRY/user-service:$IMAGE_TAG $ECR_REGISTRY/user-service:latest
        docker push $ECR_REGISTRY/user-service:latest

    - name: Build and push Cart Service
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        cd microservices/cart-service
        docker build -t $ECR_REGISTRY/cart-service:$IMAGE_TAG .
        docker push $ECR_REGISTRY/cart-service:$IMAGE_TAG
        docker tag $ECR_REGISTRY/cart-service:$IMAGE_TAG $ECR_REGISTRY/cart-service:latest
        docker push $ECR_REGISTRY/cart-service:latest

    - name: Build and push Order Service
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        cd microservices/order-service
        docker build -t $ECR_REGISTRY/order-service:$IMAGE_TAG .
        docker push $ECR_REGISTRY/order-service:$IMAGE_TAG
        docker tag $ECR_REGISTRY/order-service:$IMAGE_TAG $ECR_REGISTRY/order-service:latest
        docker push $ECR_REGISTRY/order-service:latest

  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

    - name: Deploy to EKS
      run: |
        kubectl apply -f k8s/namespaces/
        kubectl apply -f k8s/databases/
        kubectl apply -f k8s/configmaps/
        kubectl apply -f k8s/deployments/
        kubectl apply -f k8s/services/
        kubectl apply -f k8s/ingress/

    - name: Restart deployments
      run: |
        kubectl rollout restart deployment/product-service -n ecommerce
        kubectl rollout restart deployment/user-service -n ecommerce
        kubectl rollout restart deployment/cart-service -n ecommerce
        kubectl rollout restart deployment/order-service -n ecommerce

    - name: Wait for deployments
      run: |
        kubectl rollout status deployment/product-service -n ecommerce
        kubectl rollout status deployment/user-service -n ecommerce
        kubectl rollout status deployment/cart-service -n ecommerce
        kubectl rollout status deployment/order-service -n ecommerce

    - name: Verify deployment
      run: |
        kubectl get pods -n ecommerce
        kubectl get svc -n ecommerce
        kubectl get ingress -n ecommerce
