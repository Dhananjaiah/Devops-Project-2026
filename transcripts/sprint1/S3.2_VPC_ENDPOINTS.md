# S3.2: VPC Endpoints Configuration

**Video Duration:** ~8 minutes  
**Story Points:** 2

---

## Learning Objectives

By the end of this video, you will be able to:
- Understand VPC Endpoints and PrivateLink
- Create Interface and Gateway endpoints
- Reduce NAT Gateway costs
- Improve security by keeping traffic private

---

## Transcript

### Introduction (0:00 - 1:00)

Welcome back! Quick question - what if I told you that you can reduce your NAT Gateway costs AND improve security at the same time?

That's what VPC Endpoints do. Let's dive in!

### The Problem (1:00 - 2:00)

Right now, when our EKS nodes pull images from ECR, here's what happens:

1. Request goes to NAT Gateway
2. NAT Gateway sends to Internet Gateway
3. Traffic goes over the public internet
4. Reaches ECR endpoint

This costs money (NAT Gateway charges per GB) and is less secure (traffic leaves your VPC).

### The Solution: VPC Endpoints (2:00 - 3:00)

VPC Endpoints create private connections to AWS services. Traffic never leaves the AWS network!

There are two types:

**Gateway Endpoints** - Free! Used for S3 and DynamoDB.

**Interface Endpoints** - Powered by PrivateLink. Small hourly cost. Used for ECR, EKS API, and most other services.

### Creating Gateway Endpoints (3:00 - 4:30)

Let's add S3 and DynamoDB endpoints:

```hcl
resource "aws_vpc_endpoint" "s3" {
  vpc_id       = aws_vpc.main.id
  service_name = "com.amazonaws.${var.region}.s3"
  vpc_endpoint_type = "Gateway"

  route_table_ids = [
    aws_route_table.private.id
  ]

  tags = {
    Name = "${var.project_name}-${var.environment}-s3-endpoint"
  }
}

resource "aws_vpc_endpoint" "dynamodb" {
  vpc_id       = aws_vpc.main.id
  service_name = "com.amazonaws.${var.region}.dynamodb"
  vpc_endpoint_type = "Gateway"

  route_table_ids = [
    aws_route_table.private.id
  ]
}
```

These are FREE and reduce NAT Gateway usage whenever nodes access S3 or DynamoDB.

### Creating Interface Endpoints for EKS (4:30 - 6:30)

For EKS, we need several endpoints:

```hcl
resource "aws_vpc_endpoint" "ecr_api" {
  vpc_id              = aws_vpc.main.id
  service_name        = "com.amazonaws.${var.region}.ecr.api"
  vpc_endpoint_type   = "Interface"
  subnet_ids          = aws_subnet.private[*].id
  security_group_ids  = [aws_security_group.vpc_endpoints.id]
  private_dns_enabled = true
}

resource "aws_vpc_endpoint" "ecr_dkr" {
  vpc_id              = aws_vpc.main.id
  service_name        = "com.amazonaws.${var.region}.ecr.dkr"
  vpc_endpoint_type   = "Interface"
  subnet_ids          = aws_subnet.private[*].id
  security_group_ids  = [aws_security_group.vpc_endpoints.id]
  private_dns_enabled = true
}
```

ECR needs two endpoints - one for the API and one for Docker registry.

We also need an STS endpoint for IRSA:

```hcl
resource "aws_vpc_endpoint" "sts" {
  vpc_id              = aws_vpc.main.id
  service_name        = "com.amazonaws.${var.region}.sts"
  vpc_endpoint_type   = "Interface"
  subnet_ids          = aws_subnet.private[*].id
  security_group_ids  = [aws_security_group.vpc_endpoints.id]
  private_dns_enabled = true
}
```

### Security Group for Endpoints (6:30 - 7:30)

Interface endpoints need a security group:

```hcl
resource "aws_security_group" "vpc_endpoints" {
  name_prefix = "${var.project_name}-${var.environment}-vpce-"
  vpc_id      = aws_vpc.main.id

  ingress {
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    cidr_blocks = [var.vpc_cidr]
  }
}
```

This allows HTTPS traffic from anywhere in the VPC.

### Cost Consideration (7:30 - 8:00)

Interface endpoints cost about $7.50/month each, plus $0.01/GB processed. 

For a busy cluster, this is usually cheaper than NAT Gateway data transfer costs. Plus, you get better performance and security!

### Summary

We added:
1. S3 Gateway Endpoint (free)
2. DynamoDB Gateway Endpoint (free)
3. ECR Interface Endpoints (for private image pulls)
4. STS Endpoint (for IRSA)

Our cluster now has private access to key AWS services!

---

## Key Takeaways

- Gateway Endpoints are free (S3, DynamoDB)
- Interface Endpoints provide PrivateLink connectivity
- Private DNS makes endpoints transparent to applications
- VPC Endpoints reduce NAT Gateway costs
- Traffic stays within AWS network = better security
