# S7.1: Prometheus Stack Installation

**Video Duration:** ~12 minutes  
**Story Points:** 3

---

## Learning Objectives

By the end of this video, you will be able to:
- Install kube-prometheus-stack
- Understand Prometheus architecture
- Configure ServiceMonitors
- Access Prometheus UI

---

## Transcript

### Introduction (0:00 - 1:00)

Welcome back! We have applications running, but can we monitor them? What's the CPU usage? Error rates? Latency?

We need observability, and Prometheus is the industry standard for Kubernetes monitoring.

### Prometheus Architecture (1:00 - 2:30)

*[Shows architecture diagram]*

**Prometheus Server** - Scrapes and stores metrics
**AlertManager** - Handles alerts and notifications
**Grafana** - Visualization dashboards
**ServiceMonitors** - Define what to scrape

Prometheus uses a pull model - it reaches out to your services and scrapes metrics endpoints.

### Installing kube-prometheus-stack (2:30 - 5:00)

We'll use the community Helm chart that bundles everything:

```bash
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update

helm install prometheus prometheus-community/kube-prometheus-stack \
  -n monitoring \
  --create-namespace \
  -f monitoring/prometheus-values.yaml
```

Our values file:

```yaml
# prometheus-values.yaml
prometheus:
  prometheusSpec:
    retention: 15d
    resources:
      requests:
        cpu: 200m
        memory: 512Mi

alertmanager:
  alertmanagerSpec:
    resources:
      requests:
        cpu: 50m
        memory: 64Mi

grafana:
  adminPassword: "TechITFactory123!"
  persistence:
    enabled: true
    size: 10Gi
```

Let's verify:

```bash
kubectl get pods -n monitoring
```

*[Shows many pods running]*

That's a lot of pods! We have Prometheus, AlertManager, Grafana, node exporters, and more.

### Accessing Prometheus UI (5:00 - 6:30)

```bash
kubectl port-forward svc/prometheus-kube-prometheus-prometheus -n monitoring 9090:9090
```

*[Opens browser to http://localhost:9090]*

This is Prometheus! Let's try a query:

```promql
up
```

*[Shows targets being scraped]*

All the Kubernetes components are being monitored automatically!

### Understanding ServiceMonitors (6:30 - 8:30)

ServiceMonitors tell Prometheus what to scrape:

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: api-gateway
  namespace: monitoring
spec:
  selector:
    matchLabels:
      app: api-gateway
  namespaceSelector:
    matchNames:
      - techitfactory
  endpoints:
    - port: http
      path: /metrics
      interval: 30s
```

This tells Prometheus: "Scrape any service with label `app: api-gateway` on the `/metrics` endpoint."

### Built-in Dashboards (8:30 - 10:00)

The stack comes with preconfigured dashboards:

```bash
kubectl port-forward svc/prometheus-grafana -n monitoring 3000:80
```

*[Opens Grafana]*

Login: admin / TechITFactory123!

*[Shows dashboard list]*

Look at all these! Kubernetes cluster overview, node metrics, pod metrics - all ready to use.

*[Opens Kubernetes Cluster dashboard]*

CPU, memory, network - beautiful visualizations out of the box.

### Prometheus Metrics from Our Apps (10:00 - 11:30)

Our microservices expose metrics on `/metrics`:

```promql
http_requests_total{namespace="techitfactory"}
```

*[Shows our app metrics]*

We can see request counts per service!

```promql
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))
```

P95 latency for all services.

### Summary (11:30 - 12:00)

We deployed:
1. Prometheus for metrics collection
2. AlertManager for alerting
3. Grafana for visualization
4. Pre-built dashboards
5. ServiceMonitors for custom apps

Next: Deep dive into Grafana dashboards!

---

## Key Takeaways

- kube-prometheus-stack is the standard K8s monitoring solution
- Prometheus uses a pull-based scraping model
- ServiceMonitors define scrape targets
- Built-in dashboards cover Kubernetes internals
- Custom app metrics need /metrics endpoint
