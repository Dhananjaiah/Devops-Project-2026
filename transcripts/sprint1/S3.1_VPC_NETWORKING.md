# S3.1: VPC Networking Implementation

**Video Duration:** ~15 minutes  
**Story Points:** 5

---

## Learning Objectives

By the end of this video, you will be able to:
- Design production VPC architecture
- Create public and private subnets
- Configure NAT Gateway for private subnet internet access
- Set up route tables and associations

---

## Transcript

### Introduction (0:00 - 1:00)

Welcome back! This is where we start building real infrastructure. We're creating a production-grade VPC that will host our EKS cluster.

VPC design is often underestimated, but get it wrong and you'll have security issues, connectivity problems, and expensive re-architecture later. Let's do it right!

### The Architecture (1:00 - 3:00)

Let me explain what we're building:

*[Shows architecture diagram]*

We have a VPC spanning two Availability Zones for high availability.

**Public Subnets** - These have direct internet access via an Internet Gateway. Load balancers live here.

**Private Subnets** - No direct internet access. Our EKS worker nodes live here. They reach the internet through NAT Gateway.

Why this separation? Security! Workloads in private subnets can't be directly accessed from the internet. Attackers can't reach them.

The CIDR is 10.0.0.0/16, giving us 65,536 IP addresses - plenty of room to grow.

### Creating the VPC (3:00 - 5:00)

Let's write the code:

```hcl
resource "aws_vpc" "main" {
  cidr_block           = var.vpc_cidr
  enable_dns_hostnames = true
  enable_dns_support   = true

  tags = {
    Name = "${var.project_name}-${var.environment}-vpc"
  }
}
```

I'm enabling DNS hostnames and support. This is required for EKS and many AWS services to work properly.

### Internet Gateway (5:00 - 5:30)

```hcl
resource "aws_internet_gateway" "main" {
  vpc_id = aws_vpc.main.id

  tags = {
    Name = "${var.project_name}-${var.environment}-igw"
  }
}
```

The internet gateway provides connectivity between the VPC and the internet. It's attached to public subnets.

### Creating Subnets (5:30 - 8:00)

Now for the subnets. I'm using `count` to create subnets in multiple AZs:

```hcl
resource "aws_subnet" "public" {
  count                   = length(var.availability_zones)
  vpc_id                  = aws_vpc.main.id
  cidr_block              = cidrsubnet(var.vpc_cidr, 8, count.index)
  availability_zone       = var.availability_zones[count.index]
  map_public_ip_on_launch = true

  tags = {
    Name                     = "${var.project_name}-${var.environment}-public-${count.index + 1}"
    "kubernetes.io/role/elb" = "1"
  }
}
```

Notice that `kubernetes.io/role/elb` tag? That tells EKS where to place public load balancers!

```hcl
resource "aws_subnet" "private" {
  count             = length(var.availability_zones)
  vpc_id            = aws_vpc.main.id
  cidr_block        = cidrsubnet(var.vpc_cidr, 8, count.index + 10)
  availability_zone = var.availability_zones[count.index]

  tags = {
    Name                              = "${var.project_name}-${var.environment}-private-${count.index + 1}"
    "kubernetes.io/role/internal-elb" = "1"
  }
}
```

Private subnets get the `internal-elb` tag for internal load balancers.

### NAT Gateway (8:00 - 10:00)

Here's a cost optimization decision:

```hcl
resource "aws_eip" "nat" {
  domain = "vpc"
}

resource "aws_nat_gateway" "main" {
  allocation_id = aws_eip.nat.id
  subnet_id     = aws_subnet.public[0].id

  tags = {
    Name = "${var.project_name}-${var.environment}-nat"
  }
}
```

I'm creating ONE NAT Gateway, not one per AZ. 

In production with high availability requirements, you'd want one per AZ. But NAT Gateways cost ~$32/month each! For dev/learning, one is fine.

### Route Tables (10:00 - 12:00)

```hcl
resource "aws_route_table" "public" {
  vpc_id = aws_vpc.main.id

  route {
    cidr_block = "0.0.0.0/0"
    gateway_id = aws_internet_gateway.main.id
  }
}

resource "aws_route_table" "private" {
  vpc_id = aws_vpc.main.id

  route {
    cidr_block     = "0.0.0.0/0"
    nat_gateway_id = aws_nat_gateway.main.id
  }
}
```

Public subnets route to the Internet Gateway.
Private subnets route to the NAT Gateway.

Now associate them:

```hcl
resource "aws_route_table_association" "public" {
  count          = length(var.availability_zones)
  subnet_id      = aws_subnet.public[count.index].id
  route_table_id = aws_route_table.public.id
}

resource "aws_route_table_association" "private" {
  count          = length(var.availability_zones)
  subnet_id      = aws_subnet.private[count.index].id
  route_table_id = aws_route_table.private.id
}
```

### Deploying (12:00 - 14:00)

Let's deploy:

```bash
cd techitfactory-infra/environments/dev
terraform init
terraform plan
```

*[Shows plan output]*

We're creating 12 resources - VPC, subnets, route tables, NAT Gateway, etc.

```bash
terraform apply
```

*[Waits for completion]*

Done! Let's verify in the AWS Console.

*[Shows VPC in Console]*

There's our VPC with all the subnets properly configured!

### Summary (14:00 - 15:00)

We created:
1. VPC with 10.0.0.0/16 CIDR
2. 2 public subnets with internet access
3. 2 private subnets for EKS nodes
4. NAT Gateway for private subnet outbound traffic
5. Proper route tables and associations
6. EKS-required tags for load balancer placement

Next up: VPC Endpoints for even better security!

---

## Key Takeaways

- Public subnets for internet-facing resources, private for workloads
- NAT Gateway enables private subnet internet access
- Kubernetes tags are required for EKS load balancer placement
- Single NAT Gateway saves cost but reduces HA
- Always enable DNS hostnames for AWS service integration
