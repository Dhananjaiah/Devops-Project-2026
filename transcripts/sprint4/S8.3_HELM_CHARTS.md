# S8.3: Helm Charts for Microservices

**Video Duration:** ~12 minutes  
**Story Points:** 3

---

## Learning Objectives

By the end of this video, you will be able to:
- Create reusable Helm charts
- Template Kubernetes manifests
- Use values files for configuration
- Deploy applications with Helm

---

## Transcript

### Introduction (0:00 - 1:00)

Welcome back! We have Docker images, but how do we deploy them consistently? Helm is the package manager for Kubernetes.

Instead of writing YAML for each service, we create ONE template that works for all!

### Helm Chart Structure (1:00 - 2:30)

```
charts/microservice/
├── Chart.yaml          # Chart metadata
├── values.yaml         # Default values
├── values/
│   ├── api-gateway.yaml
│   ├── product-service.yaml
│   └── ...
└── templates/
    ├── _helpers.tpl    # Template helpers
    ├── deployment.yaml
    ├── service.yaml
    ├── hpa.yaml
    └── serviceaccount.yaml
```

One chart, multiple values files for each service!

### Chart.yaml (2:30 - 3:00)

```yaml
apiVersion: v2
name: microservice
description: Generic microservice Helm chart
version: 1.0.0
appVersion: "1.0.0"
```

Simple metadata about our chart.

### Deployment Template (3:00 - 6:00)

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "microservice.fullname" . }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      {{- include "microservice.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "microservice.selectorLabels" . | nindent 8 }}
    spec:
      containers:
        - name: {{ .Chart.Name }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          ports:
            - containerPort: {{ .Values.service.targetPort }}
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
          {{- if .Values.probes.liveness.enabled }}
          livenessProbe:
            httpGet:
              path: {{ .Values.probes.liveness.path }}
              port: {{ .Values.probes.liveness.port }}
          {{- end }}
          env:
            {{- toYaml .Values.env | nindent 12 }}
```

Everything is templated! Values come from the values file.

### Values Files (6:00 - 8:00)

Default values:

```yaml
# values.yaml
replicaCount: 2

image:
  repository: nginx
  tag: latest

service:
  port: 80
  targetPort: 80

resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 256Mi

probes:
  liveness:
    enabled: true
    path: /health
    port: 3000
```

Service-specific values:

```yaml
# values/api-gateway.yaml
replicaCount: 2

image:
  repository: ACCOUNT.dkr.ecr.ap-south-1.amazonaws.com/techitfactory/api-gateway
  tag: latest

service:
  port: 80
  targetPort: 3000

env:
  - name: PRODUCT_SERVICE_URL
    value: "http://product-service"
  - name: ORDER_SERVICE_URL
    value: "http://order-service"
```

### HPA Template (8:00 - 9:00)

```yaml
{{- if .Values.autoscaling.enabled }}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "microservice.fullname" . }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "microservice.fullname" . }}
  minReplicas: {{ .Values.autoscaling.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.maxReplicas }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.targetCPUUtilization }}
{{- end }}
```

Conditional HPA - only created if autoscaling is enabled.

### Deploying with Helm (9:00 - 11:00)

```bash
# Render templates to see what would be created
helm template api-gateway ./charts/microservice \
  -f ./charts/microservice/values/api-gateway.yaml

# Install
helm install api-gateway ./charts/microservice \
  -f ./charts/microservice/values/api-gateway.yaml \
  -n techitfactory

# Upgrade with new values
helm upgrade api-gateway ./charts/microservice \
  -f ./charts/microservice/values/api-gateway.yaml \
  --set image.tag=v1.0.1

# List releases
helm list -n techitfactory
```

### Summary (11:00 - 12:00)

We created:
1. Reusable microservice chart
2. Templated Deployment, Service, HPA
3. Per-service values files
4. Conditional resources

Next: Walking skeleton deployment!

---

## Key Takeaways

- One Helm chart can deploy many services
- Values files customize each deployment
- Templates use Go templating syntax
- Conditionals enable/disable features
- helm template previews output before install
