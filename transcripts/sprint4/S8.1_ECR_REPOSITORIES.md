# S8.1: ECR Repository Setup

**Video Duration:** ~8 minutes  
**Story Points:** 2

---

## Learning Objectives

By the end of this video, you will be able to:
- Create ECR repositories with Terraform
- Configure lifecycle policies
- Enable image scanning
- Push Docker images

---

## Transcript

### Introduction (0:00 - 0:30)

Welcome to Sprint 4! We're containerizing our applications. First, we need somewhere to store our Docker images - that's ECR, Elastic Container Registry.

### Creating ECR Module (0:30 - 3:00)

```hcl
# modules/ecr/main.tf
resource "aws_ecr_repository" "main" {
  for_each = toset(var.repositories)
  
  name                 = "${var.project_name}/${each.value}"
  image_tag_mutability = "MUTABLE"
  
  image_scanning_configuration {
    scan_on_push = var.scan_on_push
  }
}
```

We're creating one repository per microservice:
- frontend
- api-gateway
- product-service
- order-service
- cart-service
- user-service

### Lifecycle Policies (3:00 - 5:00)

ECR charges for storage. Let's auto-delete old images:

```hcl
resource "aws_ecr_lifecycle_policy" "main" {
  for_each   = aws_ecr_repository.main
  repository = each.value.name

  policy = jsonencode({
    rules = [{
      rulePriority = 1
      description  = "Keep last 30 images"
      selection = {
        tagStatus   = "any"
        countType   = "imageCountMoreThan"
        countNumber = var.lifecycle_policy_count
      }
      action = {
        type = "expire"
      }
    }]
  })
}
```

This keeps only the last 30 images. Older ones are automatically deleted.

### Deploying ECR (5:00 - 6:00)

```bash
terraform apply
```

*[Shows 6 repositories created]*

Let's verify:

```bash
aws ecr describe-repositories --query 'repositories[*].repositoryName'
```

### Pushing an Image (6:00 - 7:30)

```bash
# Login to ECR
aws ecr get-login-password --region ap-south-1 | \
  docker login --username AWS --password-stdin \
  ACCOUNT.dkr.ecr.ap-south-1.amazonaws.com

# Build image
docker build -t techitfactory/api-gateway:latest services/api-gateway

# Tag for ECR
docker tag techitfactory/api-gateway:latest \
  ACCOUNT.dkr.ecr.ap-south-1.amazonaws.com/techitfactory/api-gateway:latest

# Push
docker push ACCOUNT.dkr.ecr.ap-south-1.amazonaws.com/techitfactory/api-gateway:latest
```

### Summary (7:30 - 8:00)

We created:
1. 6 ECR repositories
2. Lifecycle policies for cleanup
3. Image scanning enabled
4. Tested image push

Next: Writing production Dockerfiles!

---

## Key Takeaways

- ECR provides private Docker registry in AWS
- Lifecycle policies control storage costs
- Image scanning detects vulnerabilities
- ECR login tokens expire in 12 hours
